var Loader=function(){var a=this;a.players=[],a.physics=new Loader.Physics,Loader.prototype.render=function(){for(i in a.players)item=a.players[i],item.update();a.physics.update()}};Loader.Host={},Loader.Client={},Loader.prototype.createRenderer=function(){return this.renderer=new Loader.Renderer(this.render)},Loader.prototype.createPlayer=function(a,b){var c=this,d=new Loader.Host.Player(a,b,c.physics.world);return c.players.push(d),"undefined"!=typeof this.renderer&&c.renderer.addPlayer(d),c.addText("* "+d.name+" was moved to red"),d},Loader.prototype.addText=function(a){return this.renderer?void this.renderer.addText(a):!1},Loader.Client.Player=function(a,b){this.name=a,this.avatar=b,this.x=0,this.y=0,this.point=function(){return{x:this.x,y:this.y}},this.update=new Function},Loader.Client.Renderer=function(){this.prototype=new Loader.Renderer,this.prototype.renderPlayers=this.renderPlayers},Loader.Client.Renderer.prototype.addPlayer=function(a,b){var c=this;p=new Loader.Client.Renderer.RendererNetPlayer(b),c.prototype.camera.addChild(p.graphics),this.prototype.players.put(a,p)},Loader.Client.Renderer.prototype.renderPlayers=function(){var a=this;keys=a.players.keys();for(i in keys)item=a.players.get(keys[i]),point=item.point,item.graphics.position.x=point.x,item.graphics.position.y=point.y},Loader.Client.Renderer.RendererNetPlayer=function(a){var b=this;this.graphics=new PIXI.Graphics,b.graphics.position=new PIXI.Vector(0,0),b.graphics.lineStyle(3,16777215),b.graphics.beginFill(15035990,1),b.graphics.drawCircle(0,0,30*hx.constants.Player.RADIUS),b.name_label=new PIXI.Text(a,{font:"25px Arial",fill:"white",align:"center"}),b.name_label.y=30*hx.constants.Player.RADIUS,b.graphics.endFill(),this.point={x:0,y:0},b.graphics.addChild(b.name_label)},Loader.Client.Controller=function(a){var b=this;b.keys=[!1,!1,!1,!1],b.Directions=hx.constants.Directions,document.addEventListener("keydown",function(a){a.keyCode>36&&a.keyCode<41&&(b.keys[b.Directions[a.keyCode]]=!0,console.log(a.keyCode))}),document.addEventListener("keyup",function(a){b.keys[b.Directions[a.keyCode]]=!1,console.log(a.keyCode)})},Loader.Host.Controller=function(a){var b=this;this.player=a,document.addEventListener("keydown",function(a){a.keyCode>36&&a.keyCode<41&&(b.player.keys[hx.constants.Directions[a.keyCode]]=!0,console.log(a.keyCode))}),document.addEventListener("keyup",function(a){b.player.keys[hx.constants.Directions[a.keyCode]]=!1,console.log(a.keyCode)})},Loader.Host.Player=function(a,b,c){var d=this;this.keys=[!1,!1,!1,!1],this.physics=new Loader.Physics.Player(c),this.name=a,this.avatar=b,this.point=function(){return v=d.physics.body.GetPosition(),{x:v.x,y:v.y}},this.update=function(){var a=new PIXI.Vector(0,0);return window.vec=new PIXI.Vector(0,0),d.keys.forEach(function(b,c){if(b){var d=new Loader.Physics.Vec(-90*c,200);a.add(d.vec)}}),a.length()>0&&d.physics.body.ApplyForce(a,d.physics.body.GetWorldCenter()),"updated"}},Loader.Net=function(){this.max=8,this.isHost=!1,this.clients=new Hashtable},Loader.Net.prototype.getRooms=function(){return this.roomlist},Loader.Net.prototype.stopUpdates=function(){"undefined"!=typeof this.timer&&clearInterval(this.timer)},Loader.Net.prototype.startUpdates=function(){"undefined"==typeof this.timer&&(this.timer=this.isHost?setInterval(this.updateClients,hx.intervals):setInterval(this.sendUpdatesToHost,hx.intervals))},Loader.Net.prototype.updateClients=function(){n=["host"],n.push(game.players[0].point()),game.first&&game.first.open&&game.first.send(n),keys=game.net.clients.keys();for(i in keys){item=keys[i],n=[item],n.push(game.net.clients.get(item).point());for(x in game.net.peer.connections)con=game.net.peer.connections[x][0],con.send(n)}},Loader.Net.prototype.sendUpdatesToHost=function(){window.host.send(game.controller.keys)},Loader.Net.prototype.updateFromHost=function(a){game.renderer.prototype.players.get(a[0]).point=a[1]},Loader.Net.prototype.joinRoom=function(a,b){var c=this;return this.host=a,this.peer=new Peer({host:hx.server.host,path:"/api",port:hx.server.port,key:hx.server.key}),this.peer.on("open",function(a){console.log("My peer ID is: "+a),c.connection=this.connect(c.host),c.connection.on("open",function(){console.log("connected to host!"),window.host=c.connection,callbacks.on_host_connect()}),c.connection.on("data",function(a){c.updateFromHost(a)}),c.connection.on("error",function(a){console.log(a)})}),this},Loader.Net.prototype.receiveClientData=function(a,b){this.clients.get(a.peer).keys=b},Loader.Net.prototype.sendMessage=function(){this.isHost},Loader.Net.prototype.createRoom=function(a){var b=this;this.isHost=!0,this.peer=new Peer({host:hx.server.host,path:"/api",port:hx.server.port,key:hx.server.key}),this.peer.on("open",function(c){console.log("My peer ID is: "+c),console.log("waiting for connections"),a.on_peer_init(),b.peer.on("connection",function(c){console.log("new peer "+c.peer+" connected"),a.on_peer_connect(c.peer),game.first=c,c.on("close",function(){game.net.clients.remove(c.peer),a.on_peer_dc(c)}),c.on("data",function(a){b.receiveClientData(c,a)})})}),this.peer.on("error",function(b){a.on_error(b)})};var b2Vec2=Box2D.Common.Math.b2Vec2,b2BodyDef=Box2D.Dynamics.b2BodyDef,b2Body=Box2D.Dynamics.b2Body,b2FixtureDef=Box2D.Dynamics.b2FixtureDef,b2Fixture=Box2D.Dynamics.b2Fixture,b2World=Box2D.Dynamics.b2World,b2MassData=Box2D.Collision.Shapes.b2MassData,b2PolygonShape=Box2D.Collision.Shapes.b2PolygonShape,b2ContactListener=Box2D.Dynamics.b2ContactListener,b2CircleShape=Box2D.Collision.Shapes.b2CircleShape;Loader.Physics=function(){this.world=new b2World(new b2Vec2(0,0),!0)},Loader.Physics.Player=function(a){var b=new b2BodyDef;b.type=b2Body.b2_dynamicBody,this.keys=[!1,!1,!1,!1];var c=new b2FixtureDef;c.friction=hx.constants.Player.FRICTION,c.restitution=hx.constants.Player.RESTITUTION,c.shape=new b2CircleShape(30*hx.constants.Player.RADIUS),b.position.x=100/hx.constants.World.SCALE,b.position.y=100/hx.constants.World.SCALE,b.linearDamping=hx.constants.Player.LD,b.angularDamping=hx.constants.Player.AD,this.body=a.CreateBody(b),this.body.CreateFixture(c)},Loader.Physics.Player.prototype.update=function(){var a=this,b=new PIXI.Vector(0,0);window.vec=new PIXI.Vector(0,0),a.keys.forEach(function(a,c){if(a){var d=new Loader.Physics.Vec(-90*c,200);b.add(d.vec)}}),b.length()>0&&(console.log(this),a.body.ApplyForce(b,a.body.GetWorldCenter()))},Loader.Physics.prototype.update=function(){this.world.Step(1/60,10,10),this.world.ClearForces()},Loader.Physics.deg2rad=function(a){return a*Math.PI/180},Loader.Physics.Vec=function(a,b){var a=Loader.Physics.deg2rad(a);this.vec=new PIXI.Vector(Math.cos(a)*b,Math.sin(a)*b)},Loader.Physics.Ball=function(a){var b=new b2BodyDef;b.type=b2Body.b2_dynamicBody;var c=new b2FixtureDef;c.density=hx.constants.Ball.DENSITY,c.friction=hx.constants.Ball.FRICTION,c.restitution=hx.constants.Ball.RESTITUTION,c.shape=new b2CircleShape(hx.constants.Ball.RADIUS),b.position.x=100/hx.constants.World.SCALE,b.position.y=100/hx.constants.World.SCALE,b.linearDamping=hx.constants.Ball.LD,b.angularDamping=hx.constants.Ball.AD,this.body=a.CreateBody(b),this.body.CreateFixture(c)},Loader.Renderer=function(a){this.players=new Hashtable,this.init(),this.renderFunction=a||new Function},Loader.Renderer.prototype.init=function(){var a=this,b=PIXI.autoDetectRenderer(800,600,{antialias:!0});this.renderer=b,document.getElementById("game-view").appendChild(b.view),b.backgroundColor=9674367;var c=new PIXI.Container;a.stage=c;var d=new PIXI.Graphics;this.graphics=d;var e=new PIXI.Container;a.camera=new PIXI.Graphics,e.width=20,e.height=20,e.x=0,e.y=0,d.lineStyle(20,3944747,1),d.alpha=1,d.drawRect(0,0,800,450),d.endFill(),a.camera.beginFill(16777215),a.camera.lineStyle(1.5,0),a.camera.beginFill(16777215,1),a.camera.endFill(),a.camera.lineStyle(3,16777215,.5),a.camera.alpha=1,a.camera.drawRect(90,20,740,400),a.camera.endFill(),a.camera.lineStyle(2,0),a.camera.beginFill(16764108,1),a.camera.drawCircle(90,370,10),a.camera.endFill(),a.camera.lineStyle(2,0),a.camera.beginFill(16764108,1),a.camera.drawCircle(90,170,10),a.camera.endFill(),a.camera.lineStyle(2,0),a.camera.beginFill(255,1),a.camera.arc(80,197,25,Math.PI,1.5*Math.PI),a.camera.endFill(),a.camera.lineStyle(2,0),a.camera.beginFill(255,1),a.camera.arc(80,350,25,Math.PI/2,1*Math.PI),a.camera.endFill(),a.camera.lineStyle(2,0),a.camera.moveTo(55,197),a.camera.lineTo(55,350),a.camera.endFill();var f=new PIXI.Graphics;f.beginFill(3944747),f.drawRect(0,500,400,200),f.endFill(),f.x=0;var g=this.log=new PIXI.Text("");g.style=hx.style,g.y=510,g.x+=10,f.addChild(g),misc=new PIXI.Graphics,misc.beginFill(3944747),misc_pos={x:700,y:500},misc.drawRect(misc_pos.x,misc_pos.y,100,200),misc.endFill(),a.misc=misc,misc.beginFill(6311492),misc.drawRect(misc_pos.x,500,75,30),misc.drawRect(misc_pos.x,550,75,30);var h=new PIXI.Text("Menu (esc)",{font:"15px Arial",fill:"white",align:"center"}),i=new PIXI.Text("Options",{font:"15px Arial",fill:"white",align:"center"});h.x=misc_pos.x,h.y=500,i.x=misc_pos.x,i.y=550,misc.addChild(h),misc.addChild(i),misc.endFill(),e.addChild(a.camera),d.addChild(e),d.addChild(f),d.addChild(misc),c.addChild(d)},Loader.Renderer.prototype.startRender=function(){function a(){b.renderer.render(b.stage),b.renderFunction(),b.renderPlayers(),requestAnimationFrame(a)}var b=this;a()},Loader.Renderer.prototype.addPlayer=function(a){var b=this;p=new Loader.Renderer.RendererPlayer(a),b.camera.addChild(p.graphics),this.players.put(a,p)},Loader.Renderer.prototype.addText=function(a){this.log.text+=a+"\n"},Loader.Renderer.prototype.deletePlayer=function(a){},Loader.Renderer.prototype.renderPlayers=function(){var a=this;keys=a.players.keys();for(i in keys)item=keys[i],point=item.point(),x=point.x,y=point.y,p=a.players.get(item).graphics.position,p.x=x,p.y=y},Loader.Renderer.RendererPlayer=function(a){var b=this;this.graphics=new PIXI.Graphics,b.graphics.position=new PIXI.Vector(0,0),b.graphics.lineStyle(3,16777215),b.graphics.beginFill(15035990,1),b.graphics.drawCircle(0,0,30*hx.constants.Player.RADIUS),b.graphics.endFill(),b.name_label=new PIXI.Text(a.name,{font:"25px Arial",fill:"white",align:"center"}),b.name_label.y=30*hx.constants.Player.RADIUS,b.graphics.addChild(b.name_label)},Loader.Renderer.RendererPlayer.prototype.setAvatar=function(a){},Loader.UI=function(){this.max=8,this.getNick(),this.listRooms(),this.createListeners()},Loader.UI.prototype.getNick=function(){$("#nick-modal").modal().show()},Loader.UI.prototype.addPlayer=function(a){p=game.createPlayer(a,"20"),game.net.clients.put(a,p)},Loader.UI.prototype.playerDC=function(a){console.log(a),game.net.clients.remove(a.peer),game.addText("* "+a.peer+"has left")},Loader.UI.prototype.joinRoom=function(a){callbacks={on_host_connect:this.initClientRoom,on_error:this.hostError},game.net=new Loader.Net,game.net.joinRoom(a,callbacks)},Loader.UI.prototype.initClientRoom=function(){this.cache=$("body").html(),$("body").html("<div id='game-view'></div>"),$("body").css({"padding-top":"10px"}),game.renderer=new Loader.Client.Renderer,game.renderer.prototype.startRender(),console.log(game.ui.nick),game.renderer.addPlayer("host","host"),game.renderer.addPlayer(game.net.peer.id,game.ui.nick),game.controller=new Loader.Client.Controller,game.net.startUpdates()},Loader.UI.prototype.createRoom=function(){var a=this;callbacks={on_peer_init:function(){a.createRoomDB(),a.initHostRoom()},on_error:this.hostError,on_peer_connect:this.addPlayer,on_peer_dc:this.playerDC},game.net=new Loader.Net,game.net.createRoom(callbacks)},Loader.UI.prototype.initHostRoom=function(){this.cache=$("body").html(),$("body").html("<div id='game-view'></div>"),$("body").css({"padding-top":"10px"}),game.createRenderer().startRender(),new Loader.Host.Controller(game.createPlayer(this.nick,"avatar")),game.net.startUpdates()},Loader.UI.prototype.exitRoom=function(){$("body").html(this.cache),$("body").css({"padding-top":"70px"}),game.net.peer.disconnect(),this.listRooms(),this.createListeners()},Loader.UI.prototype.hostError=function(a){console.log("unable to create room"),console.log(a)},Loader.UI.prototype.createRoomDB=function(){$.post("/create_room",encodeURI("name="+this.room_name+"&peer="+game.net.peer.id+"&max="+this.max+"&ver="+hx.version))},Loader.UI.prototype.listRooms=function(){$.getJSON("/get_rooms",function(a){$.each(a,function(a,b){pass=b.pass?"Yes":"No",distance=20*a,$("#roomlist-table tbody").append("<tr peer="+b.peer+" class='clickable-row'><td>"+b.name+"</td><td>"+b.players+"/"+b.max+"</td><td>"+pass+"</td><td>"+distance+"</td></tr>")})})},Loader.UI.prototype.createListeners=function(){var a=this;$("#join").on("click",function(){a.joinRoom(a.selected_room)}),$("#refresh").on("click",function(){a.listRooms()}),$("#create").on("click",function(){$("#room").attr("value",a.nick+"'s room"),$("#myModal").modal().show()}),$("#roomlist-table").on("click","tbody tr",function(b){a.selected_room=$(this).attr("peer"),$(this).addClass("active").siblings().removeClass("active"),$("#join").attr("disabled",!1)}),$("#roomlist-table").on("dblclick","tbody tr",function(b){a.joinRoom($(this).attr("peer"))}),$("#play").on("click",function(){a.nick=$("#nick").val(),$("#nick-modal").modal("hide")}),$("#create_room_modal").on("click",function(){a.room_name=$("#room").val(),a.createRoom()})};