var Loader=function(){var a=this;a.players=[];a.physics=new Loader.Physics();Loader.prototype.render=function(){for(i in a.players){item=a.players[i];item.update()}a.physics.update()}};Loader.Host={};Loader.Client={};Loader.prototype.createRenderer=function(){return(this.renderer=new Loader.Renderer(this.render))};Loader.prototype.createPlayer=function(b,a){var d=this;var c=new Loader.Host.Player(b,a,d.physics.world);d.players.push(c);if(typeof this.renderer!="undefined"){d.renderer.addPlayer(c)}d.addText("* "+c.name+" was moved to red");return c};Loader.prototype.addText=function(a){if(this.renderer){this.renderer.addText(a)}else{return false}};Loader.Host.Controller=function(a){var b=this;this.player=a;document.addEventListener("keydown",function(c){if(c.keyCode>36&&c.keyCode<41){b.player.keys[hx.constants.Directions[c.keyCode]]=true;console.log(c.keyCode)}});document.addEventListener("keyup",function(c){b.player.keys[hx.constants.Directions[c.keyCode]]=false;console.log(c.keyCode)})};Loader.Client.Controller=function(a){var b=this;b.keys=[false,false,false,false];b.Directions=hx.constants.Directions;document.addEventListener("keydown",function(c){if(c.keyCode>36&&c.keyCode<41){b.keys[b.Directions[c.keyCode]]=true;console.log(c.keyCode)}});document.addEventListener("keyup",function(c){b.keys[b.Directions[c.keyCode]]=false;console.log(c.keyCode)})};Loader.Net=function(){this.max=8;this.isHost=false;this.clients=new Hashtable()};Loader.Net.prototype.getRooms=function(){return this.roomlist};Loader.Net.prototype.stopUpdates=function(){if(typeof this.timer!="undefined"){clearInterval(this.timer)}};Loader.Net.prototype.startUpdates=function(){if(typeof this.timer=="undefined"){this.timer=this.isHost?setInterval(this.updateClients,hx.intervals):setInterval(this.sendUpdatesToHost,hx.intervals)}};Loader.Net.prototype.updateClients=function(){n=["host"];n.push(game.players[0].point());if(game.first&&game.first.open){game.first.send(n)}keys=game.net.clients.keys();for(i in keys){item=keys[i];n=[item];n.push(game.net.clients.get(item).point());for(x in game.net.peer.connections){con=game.net.peer.connections[x][0];con.send(n)}}};Loader.Net.prototype.sendUpdatesToHost=function(){window.host.send(game.controller.keys)};Loader.Net.prototype.updateFromHost=function(a){game.renderer.prototype.players.get(a[0]).point=a[1]};Loader.Net.prototype.joinRoom=function(a,c){var b=this;this.host=a;this.peer=new Peer({host:hx.server.host,path:"/api",port:hx.server.port,key:hx.server.key});this.peer.on("open",function(d){console.log("My peer ID is: "+d);b.connection=this.connect(b.host);b.connection.on("open",function(){console.log("connected to host!");window.host=b.connection;callbacks.on_host_connect()});b.connection.on("data",function(e){b.updateFromHost(e)});b.connection.on("error",function(e){console.log(e)})});return this};Loader.Net.prototype.receiveClientData=function(a,b){this.clients.get(a.peer).keys=b};Loader.Net.prototype.sendMessage=function(){if(this.isHost){}else{}};Loader.Net.prototype.createRoom=function(b){var a=this;this.isHost=true;this.peer=new Peer({host:hx.server.host,path:"/api",port:hx.server.port,key:hx.server.key});this.peer.on("open",function(c){console.log("My peer ID is: "+c);console.log("waiting for connections");b.on_peer_init();a.peer.on("connection",function(d){console.log("new peer "+d.peer+" connected");b.on_peer_connect(d.peer);game.first=d;d.on("close",function(){game.net.clients.remove(d.peer);b.on_peer_dc(d)});d.on("data",function(e){a.receiveClientData(d,e)})})});this.peer.on("error",function(c){b.on_error(c)})};var b2Vec2=Box2D.Common.Math.b2Vec2,b2BodyDef=Box2D.Dynamics.b2BodyDef,b2Body=Box2D.Dynamics.b2Body,b2FixtureDef=Box2D.Dynamics.b2FixtureDef,b2Fixture=Box2D.Dynamics.b2Fixture,b2World=Box2D.Dynamics.b2World,b2MassData=Box2D.Collision.Shapes.b2MassData,b2PolygonShape=Box2D.Collision.Shapes.b2PolygonShape,b2ContactListener=Box2D.Dynamics.b2ContactListener,b2CircleShape=Box2D.Collision.Shapes.b2CircleShape;Loader.Physics=function(){var a=this;this.world=new b2World(new b2Vec2(0,0),true)};Loader.Physics.Player=function(b){var a=new b2BodyDef();a.type=b2Body.b2_dynamicBody;this.keys=[false,false,false,false];var c=new b2FixtureDef();c.friction=hx.constants.Player.FRICTION;c.restitution=hx.constants.Player.RESTITUTION;c.shape=new b2CircleShape(30*hx.constants.Player.RADIUS);a.position.x=100/hx.constants.World.SCALE;a.position.y=100/hx.constants.World.SCALE;a.linearDamping=hx.constants.Player.LD;a.angularDamping=hx.constants.Player.AD;this.body=b.CreateBody(a);this.body.CreateFixture(c)};Loader.Physics.Player.prototype.update=function(){var b=this;var a=new PIXI.Vector(0,0);window.vec=new PIXI.Vector(0,0);b.keys.forEach(function(d,c){if(d){var e=new Loader.Physics.Vec(c*-90,200);a.add(e.vec)}});if(a.length()>0){console.log(this);b.body.ApplyForce(a,b.body.GetWorldCenter())}};Loader.Physics.prototype.update=function(){this.world.Step(1/60,10,10);this.world.ClearForces()};Loader.Physics.deg2rad=function(a){return a*Math.PI/180};Loader.Physics.Vec=function(b,a){var b=Loader.Physics.deg2rad(b);this.vec=new PIXI.Vector(Math.cos(b)*a,Math.sin(b)*a)};Loader.Physics.Ball=function(b){var a=new b2BodyDef();a.type=b2Body.b2_dynamicBody;var c=new b2FixtureDef();c.density=hx.constants.Ball.DENSITY;c.friction=hx.constants.Ball.FRICTION;c.restitution=hx.constants.Ball.RESTITUTION;c.shape=new b2CircleShape(hx.constants.Ball.RADIUS);a.position.x=100/hx.constants.World.SCALE;a.position.y=100/hx.constants.World.SCALE;a.linearDamping=hx.constants.Ball.LD;a.angularDamping=hx.constants.Ball.AD;this.body=b.CreateBody(a);this.body.CreateFixture(c)};Loader.Host.Player=function(b,a,d){var c=this;this.keys=[false,false,false,false];this.physics=new Loader.Physics.Player(d);this.name=b;this.avatar=a;this.point=function(){v=c.physics.body.GetPosition();return{x:v.x,y:v.y}};this.update=function(){var e=new PIXI.Vector(0,0);window.vec=new PIXI.Vector(0,0);c.keys.forEach(function(g,f){if(g){var h=new Loader.Physics.Vec(f*-90,200);e.add(h.vec)}});if(e.length()>0){c.physics.body.ApplyForce(e,c.physics.body.GetWorldCenter())}return"updated"}};Loader.Client.Player=function(b,a){var c=this;this.name=b;this.avatar=a;this.x=0;this.y=0;this.point=function(){return{x:this.x,y:this.y}};this.update=new Function()};Loader.Renderer=function(b){var a=this;this.players=new Hashtable();this.init();this.renderFunction=b||new Function()};Loader.Renderer.prototype.init=function(){var e=this;var g=PIXI.autoDetectRenderer(800,600,{antialias:true});this.renderer=g;document.getElementById("game-view").appendChild(g.view);g.backgroundColor=9674367;var f=new PIXI.Container();e.stage=f;var h=new PIXI.Graphics();this.graphics=h;var a=new PIXI.Container();e.camera=new PIXI.Graphics();a.width=20;a.height=20;a.x=0;a.y=0;h.lineStyle(20,3944747,1);h.alpha=1;h.drawRect(0,0,800,(600-150));h.endFill();e.camera.beginFill(16777215);e.camera.lineStyle(1.5,0);e.camera.beginFill(16777215,1);e.camera.endFill();e.camera.lineStyle(3,16777215,0.5);e.camera.alpha=1;e.camera.drawRect(90,20,800-60,(600-200));e.camera.endFill();e.camera.lineStyle(2,0);e.camera.beginFill(16764108,1);e.camera.drawCircle(90,370,10);e.camera.endFill();e.camera.lineStyle(2,0);e.camera.beginFill(16764108,1);e.camera.drawCircle(90,170,10);e.camera.endFill();e.camera.lineStyle(2,0);e.camera.beginFill(255,1);e.camera.arc(90-10,177+20,25,Math.PI,(3/2)*Math.PI);e.camera.endFill();e.camera.lineStyle(2,0);e.camera.beginFill(255,1);e.camera.arc(90-10,177+173,25,Math.PI/2,(2/2)*Math.PI);e.camera.endFill();e.camera.lineStyle(2,0);e.camera.moveTo(55,197);e.camera.lineTo(55,350);e.camera.endFill();var j=new PIXI.Graphics();j.beginFill(3944747);j.drawRect(0,500,400,200);j.endFill();j.x=0;var b=this.log=new PIXI.Text("");b.style=hx.style;b.y=510;b.x+=10;j.addChild(b);misc=new PIXI.Graphics();misc.beginFill(3944747);misc_pos={x:700,y:500};misc.drawRect(misc_pos.x,misc_pos.y,100,200);misc.endFill();e.misc=misc;misc.beginFill(6311492);misc.drawRect(misc_pos.x,500,75,30);misc.drawRect(misc_pos.x,550,75,30);var d=new PIXI.Text("Menu (esc)",{font:"15px Arial",fill:"white",align:"center"});var c=new PIXI.Text("Options",{font:"15px Arial",fill:"white",align:"center"});d.x=misc_pos.x;d.y=500;c.x=misc_pos.x;c.y=550;misc.addChild(d);misc.addChild(c);misc.endFill();a.addChild(e.camera);h.addChild(a);h.addChild(j);h.addChild(misc);f.addChild(h)};Loader.Renderer.prototype.startRender=function(){var b=this;a();function a(){b.renderer.render(b.stage);b.renderFunction();b.renderPlayers();requestAnimationFrame(a)}};Loader.Renderer.prototype.addPlayer=function(a){var b=this;p=new Loader.Renderer.RendererPlayer(a);b.camera.addChild(p.graphics);this.players.put(a,p)};Loader.Renderer.prototype.addText=function(a){this.log.text+=a+"\n"};Loader.Renderer.prototype.deletePlayer=function(a){};Loader.Renderer.prototype.renderPlayers=function(){var a=this;keys=a.players.keys();for(i in keys){item=keys[i];point=item.point();x=point.x;y=point.y;p=a.players.get(item).graphics.position;p.x=x;p.y=y}};Loader.Renderer.RendererPlayer=function(a){var b=this;this.graphics=new PIXI.Graphics();b.graphics.position=new PIXI.Vector(0,0);b.graphics.lineStyle(3,16777215);b.graphics.beginFill(15035990,1);b.graphics.drawCircle(0,0,30*hx.constants.Player.RADIUS);b.graphics.endFill();b.name_label=new PIXI.Text(a.name,{font:"25px Arial",fill:"white",align:"center"});b.name_label.y=30*hx.constants.Player.RADIUS;b.graphics.addChild(b.name_label)};Loader.Renderer.RendererPlayer.prototype.setAvatar=function(a){};Loader.Client.Renderer=function(){this.prototype=new Loader.Renderer();this.prototype.renderPlayers=this.renderPlayers};Loader.Client.Renderer.prototype.addPlayer=function(a,b){var c=this;p=new Loader.Client.Renderer.RendererNetPlayer(b);c.prototype.camera.addChild(p.graphics);this.prototype.players.put(a,p)};Loader.Client.Renderer.prototype.renderPlayers=function(){var a=this;keys=a.players.keys();for(i in keys){item=a.players.get(keys[i]);point=item.point;item.graphics.position.x=point.x;item.graphics.position.y=point.y}};Loader.Client.Renderer.RendererNetPlayer=function(a){var b=this;this.graphics=new PIXI.Graphics();b.graphics.position=new PIXI.Vector(0,0);b.graphics.lineStyle(3,16777215);b.graphics.beginFill(15035990,1);b.graphics.drawCircle(0,0,30*hx.constants.Player.RADIUS);b.name_label=new PIXI.Text(a,{font:"25px Arial",fill:"white",align:"center"});b.name_label.y=30*hx.constants.Player.RADIUS;b.graphics.endFill();this.point={x:0,y:0};b.graphics.addChild(b.name_label)};Loader.UI=function(){this.max=8;this.getNick();this.listRooms();this.createListeners()};Loader.UI.prototype.getNick=function(){$("#nick-modal").modal().show()};Loader.UI.prototype.addPlayer=function(a){p=game.createPlayer(a,"20");game.net.clients.put(a,p)};Loader.UI.prototype.playerDC=function(a){console.log(a);game.net.clients.remove(a.peer);game.addText("* "+a.peer+"has left")};Loader.UI.prototype.joinRoom=function(b){var a=this;callbacks={on_host_connect:this.initClientRoom,on_error:this.hostError};game.net=new Loader.Net();game.net.joinRoom(b,callbacks)};Loader.UI.prototype.initClientRoom=function(){this.cache=$("body").html();$("body").html("<div id='game-view'></div>");$("body").css({"padding-top":"10px"});game.renderer=new Loader.Client.Renderer();
/*!-- !*/
;game.renderer.prototype.startRender();console.log(game.ui.nick);game.renderer.addPlayer("host","host");game.renderer.addPlayer(game.net.peer.id,game.ui.nick);game.controller=new Loader.Client.Controller();game.net.startUpdates()};Loader.UI.prototype.createRoom=function(){var a=this;callbacks={on_peer_init:function(){a.createRoomDB();a.initHostRoom()},on_error:this.hostError,on_peer_connect:this.addPlayer,on_peer_dc:this.playerDC};game.net=new Loader.Net();game.net.createRoom(callbacks)};Loader.UI.prototype.initHostRoom=function(){this.cache=$("body").html();$("body").html("<div id='game-view'></div>");$("body").css({"padding-top":"10px"});game.createRenderer().startRender();new Loader.Host.Controller(game.createPlayer(this.nick,"avatar"));game.net.startUpdates()};Loader.UI.prototype.exitRoom=function(){$("body").html(this.cache);$("body").css({"padding-top":"70px"});game.net.peer.disconnect();this.listRooms();this.createListeners()};Loader.UI.prototype.hostError=function(a){console.log("unable to create room");console.log(a)};Loader.UI.prototype.createRoomDB=function(){$.post("/create_room",encodeURI("name="+this.room_name+"&peer="+game.net.peer.id+"&max="+this.max+"&ver="+hx.version))};Loader.UI.prototype.listRooms=function(){$.getJSON("/get_rooms",function(b){var a=[];$.each(b,function(c,d){pass=d.pass?"Yes":"No";distance=c*20;$("#roomlist-table tbody").append("<tr peer="+d.peer+" class='clickable-row'><td>"+d.name+"</td><td>"+d.players+"/"+d.max+"</td><td>"+pass+"</td><td>"+distance+"</td></tr>")})})};Loader.UI.prototype.createListeners=function(){var a=this;$("#join").on("click",function(){a.joinRoom(a.selected_room)});$("#refresh").on("click",function(){a.listRooms()});$("#create").on("click",function(){$("#room").attr("value",a.nick+"'s room");$("#myModal").modal().show()});$("#roomlist-table").on("click","tbody tr",function(b){a.selected_room=$(this).attr("peer");$(this).addClass("active").siblings().removeClass("active");$("#join").attr("disabled",false)});$("#roomlist-table").on("dblclick","tbody tr",function(b){a.joinRoom(($(this).attr("peer")))});$("#play").on("click",function(){a.nick=$("#nick").val();$("#nick-modal").modal("hide")});$("#create_room_modal").on("click",function(){a.room_name=$("#room").val();a.createRoom()})};