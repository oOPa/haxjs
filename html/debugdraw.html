<!DOCTYPE HTML>
<html>
<head>

<title>pixi.js example 1</title>
<script src="../js/Box2dWeb-2.1.a.3.min.js"></script>
<script src="../js/constants.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/0.3.14/peer.min.js"></script>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
<script src="../js/pixi.min.js"></script>
<script src="../js/hashtable.js"></script>	
<script src="../js/pixi.vector.js"></script>
<script src="../js/physics.js"></script>	
<script src="../js/loader.js"></script>	
<script src="../js/controller.js"></script>	
<script src="../js/player.js"></script>	
<script type="text/javascript">
/** init **/
var b2DebugDraw = Box2D.Dynamics.b2DebugDraw;

window.requestAnimFrame = (function () {
    return  window.requestAnimationFrame ||
            window.webkitRequestAnimationFrame ||
            window.mozRequestAnimationFrame ||
            window.oRequestAnimationFrame ||
            window.msRequestAnimationFrame ||
            function (/* function */ callback, /* DOMElement */ element) {
                window.setTimeout(callback, 1000 / 60);
            };
})();

hx.Builder = function () {
    var that = this;
	
	/** Initialise game **/
	window.game = this.game = new Loader();
    this.canvas = document.getElementById('haxball');
    this.ctx = this.canvas.getContext('2d');
    this.world = this.game.physics.world;
	//set boundary for the stadium
    this.buildGround();
	//create the players
    this.buildPlayers();
	//create a ball
	this.buildBall();
	//create action listeners
    this.bindEvents();
    this.prepareDebugDraw();

    requestAnimFrame(function () {
        that.update();
    });

};

hx.Builder.prototype.prepareDebugDraw = function () {

    var debugDraw = new b2DebugDraw();
    debugDraw.SetSprite(this.ctx);
    debugDraw.SetDrawScale(hx.constants.World.SCALE);
    debugDraw.SetFillAlpha(1);
    debugDraw.SetLineThickness(1.0);
    debugDraw.SetFlags(b2DebugDraw.e_shapeBit | b2DebugDraw.e_jointBit);
    this.world.SetDebugDraw(debugDraw);
}

hx.Builder.prototype.update = function () {
    var that = this;
    this.updatePlayers();
    this.world.Step(1 / 60, 10, 10);
    this.world.DrawDebugData();
    this.world.ClearForces();
    requestAnimFrame(function () {
        that.update();
    });
}




hx.Builder.prototype.buildGround = function () {
    var fixDef = new b2FixtureDef();
    fixDef.density = hx.constants.Ground.DENSITY;
    fixDef.friction = hx.constants.Ground.FRICTION;
    fixDef.restitution = hx.constants.Ground.RESTITUTION;
    fixDef.shape = new b2PolygonShape();

    var bodyDef = new b2BodyDef();
    bodyDef.type = b2Body.b2_staticBody;

    for (var b in hx.grounds.G1) {
        b = hx.grounds.G1[b];
        bodyDef.position.x = b[0] / hx.constants.World.SCALE;
        bodyDef.position.y = b[1] / hx.constants.World.SCALE;
        fixDef.shape.SetAsBox((b[2] / hx.constants.World.SCALE), (b[3] / hx.constants.World.SCALE));
        this.world.CreateBody(bodyDef).CreateFixture(fixDef);
    }
};


hx.Builder.prototype.buildPlayers = function () {
	//this.onyema = this.game.createPlayer("onyema",4);
}

hx.Builder.prototype.buildBall = function () {
    this.ball = new hx.Ball(this.world);
}

hx.Builder.prototype.bindEvents = function () {
   //this.controller = new Controller(this.onyema);
};

hx.Builder.prototype.updatePlayers = function () {
	this.game.render();
};


hx.Vec = function (deg, mag) {
    var deg = deg2rad(deg);
    this.vec = new b2Vec2(Math.cos(deg) * mag, Math.sin(deg) * mag);
};

deg2rad = function (deg) {
    return deg * Math.PI / 180;
};



hx.Ball = function (world) {
    var bodyDef = new b2BodyDef();
    bodyDef.type = b2Body.b2_dynamicBody;

    var fixDef = new b2FixtureDef();
    fixDef.density = hx.constants.Ball.DENSITY;
    fixDef.friction = hx.constants.Ball.FRICTION;
    fixDef.restitution = hx.constants.Ball.RESTITUTION;
    fixDef.shape = new b2CircleShape(hx.constants.Ball.RADIUS);

    bodyDef.position.x = 100 / hx.constants.World.SCALE;
    bodyDef.position.y = 100 / hx.constants.World.SCALE;

    bodyDef.linearDamping = hx.constants.Ball.LD;
    bodyDef.angularDamping = hx.constants.Ball.AD;

    this.body = world.CreateBody(bodyDef);
    this.body.CreateFixture(fixDef);
}


window.onload = function () {
    //window.hxp = new hx.Builder();
};
</script>	
</head>
	
<body style="" onload="new hx.Builder();">

<div class="center-block" style="display:flex;justify-content:center;align-items:center;">
<div id="viewport"></div>
<canvas id="haxball" width="940" height="480" style="border: 1px solid black"></canvas>
<div id="game-view"></div>
		<div id="chat-view"></div>
		<div id="options-view"></div>
	</div>
	</body>
</html>
